<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voeux 2022</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/StephanWagner/jBox@v1.3.3/dist/jBox.all.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/StephanWagner/jBox@v1.3.3/dist/jBox.all.min.css" rel="stylesheet">    

    <style>
        body{
            margin:0px;
        }
        #mainSVG{
            width: 21cm;
            height: 59.4cm;
        }   
        #destValue{
           position: absolute;
           top: 162px;
            left: 232px;
            height: 80px;
           width: 230px;
           transform: rotate(-90deg);
           background: transparent;
           font-weight:bold;
           font-size:16px;
           line-height:1.25;
           font-family:'Liberation Sans';
        }
        #expeValue{
           position: absolute;
           left: -164px;
           top: 204px;
           width: 420px;
           height: 40px;
           transform: rotate(90deg);
           background: transparent;
           font-weight:bold;
           font-size:16px;
           line-height:1.25;
           font-family:'Liberation Sans';
        }
        
    </style>

</head>
<body>
<div id="haut" style="height:0px;"></div>    
<div id="mainSVG"></div>    
<div id="mdctPrint" style="display: none" >
    <p>La carte est prête !</p>
    <p>Vous pouvez maintenant imprimer, ajouter vos messages personnels, plier et envoyer au destinataire.</p>
    <p>Regarder un tutorial pour vous aider.</p>
    <!--
    <button onclick="mdPrint.close();window.print();" type="button">Imprimer</button>
    -->
    <button onclick="mdPrint.close();" type="button">OK</button>    
</div>
<div id="mdctChoixSource" style="display: none" >
    <p></p>
    <label for="sltChoixSource">Veuillez choisir une source pour le mésostiche.</label>

    <select name="ChoixSource" id="sltChoixSource">
        <option value="alea">--Aléatoire--</option>
        <option value="alea1">J-P Balpe - Centons de Corneille</option>
        <option value="2">J-P Balpe - Poèmes orientaux</option>
        <option value="3">J-P Balpe - Rengas</option>
        <option value="4">Cantiquest - Chants Joyeux</option>
        <option value="5">Cantiquest - Chants de Victoire</option>
        <option value="6">Victor Hugo - Contemplations</option>
        <option value="7">Mallarmé - Poésies</option>
        <option value="8">Arthur Rimbaud - Poésies</option>
        <option value="8">Paul Verlaine - Amour</option>
    </select>
    <button onclick="chargeMesostiche();" type="button">Valider</button>
</div>
<script>
const urlParams = new URLSearchParams(window.location.search)
    , random = d3.randomUniform()//d3.randomLcg(0.9051667019185816)
    , shuffle = d3.shuffler(random);

let auto = urlParams.has('auto') ?  urlParams.get('auto') : true
    , svg, mdDest, mdExp
    , html = '<div class="loading">'
        +'<p style="width:150px" >Cette carte est unique, il faut un peu de temps pour la préparer...</p>'
        +'<img width="100%" src="asset/img/moebius.gif" />'
        +'</div>'
    ,mdWait = new jBox('Modal', {
        width: 206,
        height: 300,
        title: 'Patience...',
        content: html
    })
    ,mdPrint = new jBox('Modal', {
        title: 'Imprimer',
        content: $('#mdctPrint')
    })
    ,mdChoixSource = new jBox('Modal', {
        title: 'Choix source',
        content: $('#mdctChoixSource')
    })
    ,nbRepeat = 3, curRepeat=0;


mdWait.open();

//charge le svg
d3.xml('asset/svg/voeux2022.svg')
  .then(data => {
     d3.select("#mainSVG").node().append(data.documentElement);
     svg=d3.select("#mainSVG").select('svg');
    //modal pour récupèrer l'adresse
    html = '<label for="txtDest">Saisissez les coordonnées du destinataire</label>'
        +'<textarea id="txtDest" name="txtDest" rows="5" cols="33"></textarea>'
        +'<button onclick="ajoutDestinataire();demasque(1000,animeMelangePhoto);" type="button">Ajouter</button>'
        +'<button onclick="mdDest.close();demasque(1000,animeMelangePhoto);" type="button">Anuler</button>';
    mdDest = new jBox('Modal', {
        width: 340,
        height: 200,
        attach: '#btnAjoutDestinataire',
        title: 'Coordonnées du destinataire',
        content: html
    });
    html = "<label for='txtExpe'>Saisissez les coordonnées de l'expéditeur</label>"
        +'<textarea id="txtExpe" name="txtExpe" rows="5" cols="33"></textarea>'
        +'<button onclick="changeExpediteur();mdDest.open();" type="button">Ajouter</button>'
        +'<button onclick="mdExp.close();mdDest.open();" type="button">Anuler</button>';
    mdExp = new jBox('Modal', {
        width: 340,
        height: 200,
        attach: '#btnChangeDest',
        title: "Coordonnées de l'expéditeur",
        content: html
    });
    document.getElementById('haut').scrollIntoView({block: "start", inline: "nearest"});
    if(auto){
        //masque les éléments de fond
        d3.selectAll('.btnManuel').attr('visibility','hidden');
        svg.append('rect').attr('id','masqueGlobal').attr('fill','white').attr('height','59.4cm').attr('width','21cm');
        ajoutLogoAnnee();
        //ajoutMesostiche();
    }
    mdWait.close();
  });
function demasque(h,cb){
    d3.select('#masqueGlobal').transition()
        .duration(750)
        .ease(d3.easeLinear)
        .attr('transform',`translate(0,${h})`)
        .on('end',cb);

}

function animeMelangePhoto(){
    d3.select('#masqueGlobal').remove();
    masqueMelangePhoto();        
    document.getElementById('blocMelangePhoto').scrollIntoView({ behavior: 'smooth', block: 'center' });
    melangePhoto();
}

function ajoutLogoAnnee(){
    d3.select('#gLogoAnnee').remove();
    //récupère les dimensions du bloc
    let dim = d3.select('#logoAnnee').node().getBBox();
    //calcul l'url
    let h = dim.width*10, w = dim.height*10, t='joyeux 2022'
    , url = `https://samszo.github.io/A_Maze_Logo/image.html?margin=0git&responsive=1&fctEndTexte=positionneLogo&h=${h}&w=${w}&texte=${t}`;
    console.log(url);
    svg.append('g').attr('id','gLogoAnnee').style('cursor','pointer').on('click',function(){ajoutLogoAnnee();})
    .append('foreignObject')
        .attr('id','foLogoAnnee')
        .attr('height',"100%").attr('width',"100%")
        .append("xhtml:body")
        .style("margin","0")
            .append('iframe')
                .attr('id','ifLogoAnnee')
                .attr('src',url)
                .attr("frameborder","0")
                .attr("scrolling","no")
                .attr('height',"100%").attr('width',"100%");

    /*ajoute la fenêtre de génération de l'image 
    let decaleX = 4;
    svg.append('g').attr('id','gLogoAnnee')
    .attr('transform',`translate(${decaleX},${(dim.y+dim.height)}) rotate(-90)`)
    .append('foreignObject')
        .attr('id','foLogoAnnee')
        .attr('height',dim.width).attr('width',dim.height)
        .append("xhtml:body")
        .style("margin","0")
            .append('iframe')
                .attr('id','ifLogoAnnee')
                .attr('src',url)
                .attr("frameborder","0")
                .attr("scrolling","no")
                .attr('height',dim.width).attr('width',dim.height);
    */
}
function positionneLogo(){
    const t = d3.transition()
        .duration(750)
        .ease(d3.easeLinear)
        .on('end',ajoutMesostiche);

    let decaleX = 4;
    //récupère les dimensions du bloc
    let dim = d3.select('#logoAnnee').node().getBBox();
    //positionne le bloc
    d3.select('#gLogoAnnee').transition(t)
        .attr('transform',`translate(${decaleX},${(dim.y+dim.height)}) rotate(-90)`)
    //dimensionne le bloc
    d3.select('#foLogoAnnee')
        .attr('height',dim.width).attr('width',dim.height)
    d3.select('#ifLogoAnnee')
        .attr('height',dim.width).attr('width',dim.height);
}
function ajoutMesostiche(){
    mdChoixSource.open();
}
function chargeMesostiche(){
    d3.select('#gMeso').remove();
    let source = document.getElementById('sltChoixSource').value;    
    mdChoixSource.close();
    //récupère les dimensions du bloc
    let dim = d3.select('#blocMeso').node().getBBox();
    //calcul l'url
    let h = dim.width*3, w = dim.height*3, r='MEILLEUR REVOLUTION PLANETAIRE', s = source=='alea' ? d3.randomInt(0, 8)() : source//5//Victor Hugo - contemplations
    , url = `https://samszo.github.io/mesostiche/image.html?w=${w}&h=${h}&source=${s}&regle=${r}&fctEnd=positionneMesostiche&responsive=1`;
    console.log(url);
    //ajoute la fenêtre de génération de l'image
    svg.append('g').attr('id','gMeso').style('cursor','pointer').on('click',function(){ajoutMesostiche();})
        .attr('transform',`translate(30, 0)`)
    .append('foreignObject')
        .attr('id','foMeso')
        .attr('height',dim.width).attr('width',dim.height)
        .append("xhtml:body")
        .style("margin","0")
            .append('iframe')
                .attr('if','ifMeso')
                .attr('src',url)
                .attr("frameborder","0")
                .attr("scrolling","no")
                .attr('height',dim.width).attr('width',dim.height);
    /*
    let decaleX = 25;
    svg.append('g').attr('id','gMeso')
    .attr('transform',`translate(${decaleX},${(dim.y+dim.height)}) rotate(-90)`)
    .append('foreignObject')
        .attr('id','foMeso')
        .attr('height',dim.width).attr('width',dim.height)
        .append("xhtml:body")
        .style("margin","0")
            .append('iframe')
                .attr('src',url)
                .attr("frameborder","0")
                .attr("scrolling","no")
                .attr('height',dim.width).attr('width',dim.height);
    */
}
function positionneMesostiche(){
    const t = d3.transition()
        .duration(750)
        .ease(d3.easeLinear)
        .on('end',function(){mdExp.open();});
    //récupère les dimensions du bloc
    let dim = d3.select('#blocMeso').node().getBBox();

    //positionne le bloc
    let decaleX = 25;
    d3.select('#gMeso').transition(t)
        .attr('transform',`translate(${decaleX},${(dim.y+dim.height)}) rotate(-90)`)
    //dimensionne le bloc
    d3.select('#foMeso')
        .attr('height',dim.width).attr('width',dim.height)
    d3.select('#ifMeso')
        .attr('height',dim.width).attr('width',dim.height);
}

function ajoutDestinataire(){
    //récupère les données saisies
    let txt = document.getElementById('txtDest').value;
    //ajoute le texte pour le destinataire
    d3.select('#mainSVG').append('textarea')
        .attr('id',"destValue")
        .attr('rows',"5")
        .attr('cols',"33")
        .html(txt);
    d3.select('#btnAjoutDestinataire').attr('visibility','hidden');
    mdDest.close();
}
function changeExpediteur(){
    //récupère les données saisies
    let txt = document.getElementById('txtExpe').value;
    //ajoute le texte pour le destinataire
    d3.select('#mainSVG').append('textarea')
        .attr('id',"expeValue")
        .attr('rows',"2")
        .attr('cols',"33")
        .html(txt);        
    mdExp.close();
    d3.select('#btnChangeDest').attr('visibility','hidden');    
}

function melangePhoto(){
    //récupère les photos
    let photos = d3.select('#photoPatchwork').selectAll('image')
        , newPosis = shufflePhotoPosition(photos)
        , nbTrans = 0;
    //met à jour les positions
    photos.transition()
        .delay(function(d, i) { return i * 50; })
        .on("start", function repeat() {
            let p = newPosis.filter(np=>np.id==this.id)[0];
            if(p){
                d3.active(this)
                .transition()
                    .duration(1000)
                    .ease(d3.easeCubicInOut)
                    .attr('x',p.x)
                .transition()
                    .duration(1000)
                    .ease(d3.easeCubicInOut)
                    .attr('y',p.y)                
                .on("end", function(){
                    nbTrans++;
                    if(newPosis.length == nbTrans){
                        if(nbRepeat > curRepeat){
                            curRepeat++;
                            melangePhoto();
                        }else{
                            imprimeCarte();
                        } 
                    }
                })
            }
        });
    /*
    newPosis.forEach(p=>{
        d3.select('#'+p.id).attr('x',p.x).attr('y',p.y);
    })
    */
}
function shufflePhotoPosition(photos){
    //récupère les positions
    let positions = []
    photos.each(function(p, j) {
        let n = d3.select(this);
        positions.push({'x':Number(n.attr('x')),'y':Number(n.attr('y')),'id':n.attr('id')
            ,'height':Number(n.attr('height')),'width':Number(n.attr('width'))});
    });
    //calcul les nouvelles positions
    let newPosis=[], nbPosi=positions.length
        , extX = d3.extent(positions.map(p=>p.x)),extY = d3.extent(positions.map(p=>p.y))
        , curX=extX[0], curY=extY[0]; 
    for (let i = 0; i < nbPosi; i++) {
       let p = shuffle(positions).pop();
       if(curX > extX[1]){
        curX=extX[0];
        curY+=p.height;
       }
       p.x = curX;
       p.y = curY;
       curX+=p.width;
       //on vérifie le dépacement en Y
       if(p.y <= extY[1])newPosis.push(p);
    }
    return newPosis;
}

function masqueMelangePhoto(){
    d3.select('#blocMelangePhoto').attr('visibility','hidden');    
}

function imprimeCarte(){
    mdPrint.open();
}

</script>
</body>
</html>